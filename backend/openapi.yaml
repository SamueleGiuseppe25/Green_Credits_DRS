openapi: 3.1.0
info:
  title: GreenCredits API (MVP)
  version: 0.1.0
  description: >
    Minimal contract for parallel frontend/backend work.
    Covers auth, wallet, machine simulator, receipt claims, return points and health checks.

servers:
  - url: https://api.greencredits.local
    description: Local/staging (replace in deploy)

tags:
  - name: Auth
  - name: Wallet
  - name: Simulator
  - name: Claims
  - name: ReturnPoints
  - name: Health

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    IdempotencyKey:
      name: Idempotency-Key
      in: header
      required: false
      description: Client-supplied key to make POST idempotent.
      schema: { type: string, maxLength: 128 }

  schemas:
    Error:
      type: object
      required: [code, message]
      properties:
        code: { type: string, example: VALIDATION_ERROR }
        message: { type: string, example: "Amount must be >= 0" }
        details:
          description: Optional field-level details or context.
          oneOf:
            - type: string
            - type: object
            - type: array

    AuthRegisterRequest:
      type: object
      required: [email, password]
      properties:
        email: { type: string, format: email, example: "sam@example.com" }
        password: { type: string, format: password, minLength: 8 }
        fullName: { type: string, example: "Sam Quarato" }

    AuthLoginRequest:
      type: object
      required: [email, password]
      properties:
        email: { type: string, format: email }
        password: { type: string, format: password }

    AuthTokenResponse:
      type: object
      required: [accessToken, refreshToken, tokenType, expiresIn]
      properties:
        accessToken: { type: string, example: "eyJhbGciOi..." }
        refreshToken: { type: string, example: "eyJhbGciOi..." }
        tokenType: { type: string, example: "Bearer" }
        expiresIn: { type: integer, example: 3600 }

    WalletBalanceResponse:
      type: object
      required: [balanceCents, lastUpdated]
      properties:
        balanceCents: { type: integer, example: 1230, description: "€12.30 = 1230" }
        lastUpdated: { type: string, format: date-time }

    Transaction:
      type: object
      required: [id, ts, kind, amountCents]
      properties:
        id: { type: string, example: "txn_01H..." }
        ts: { type: string, format: date-time }
        kind:
          type: string
          enum: [return, redeem, donation, adjustment]
        amountCents: { type: integer, example: 150 }
        note: { type: string, example: "5 cans @ €0.15" }

    WalletHistoryResponse:
      type: object
      required: [items, total, page, pageSize]
      properties:
        items:
          type: array
          items: { $ref: "#/components/schemas/Transaction" }
        total: { type: integer, example: 42 }
        page: { type: integer, example: 1 }
        pageSize: { type: integer, example: 20 }

    SimulateReturnRequest:
      type: object
      required: [containers]
      properties:
        containers:
          type: array
          description: List of returned container groups.
          items:
            type: object
            required: [type, count]
            properties:
              type:
                type: string
                enum: [can, small_bottle, large_bottle]
              count:
                type: integer
                minimum: 1
                example: 5

    SimulateReturnResponse:
      type: object
      required: [receiptId, creditedCents, newBalanceCents]
      properties:
        receiptId: { type: string, example: "rcp_01H..." }
        creditedCents: { type: integer, example: 75 }
        newBalanceCents: { type: integer, example: 1305 }

    ClaimSubmitResponse:
      type: object
      required: [claimId, status, parsed]
      properties:
        claimId: { type: string, example: "clm_01H..." }
        status:
          type: string
          enum: [Pending, Approved, Rejected]
          example: Pending
        parsed:
          type: object
          properties:
            receiptId: { type: string, example: "366073070" }
            retailer: { type: string, example: "SuperValu Dundrum" }
            amountCents: { type: integer, example: 105 }
            ts: { type: string, format: date-time, example: "2024-03-23T10:21:00Z" }
          description: Parsed values are best-effort; subject to admin review.

    ReturnPoint:
      type: object
      required: [id, name, type, lat, lng]
      properties:
        id: { type: string, example: "rp_001" }
        name: { type: string, example: "SuperMart Dundrum RVM" }
        type: { type: string, enum: [RVM, Manual] }
        eircode: { type: string, example: "D14 XXXX" }
        retailer: { type: string, example: "SuperMart" }
        lat: { type: number, format: float, example: 53.2891 }
        lng: { type: number, format: float, example: -6.2387 }
        hours:
          type: object
          additionalProperties: { type: string }
          example: { mon_fri: "08:00-22:00", sat: "08:00-22:00", sun: "09:00-21:00" }
        services:
          type: array
          items: { type: string, enum: [voucher, donation] }
        lastVerifiedAt: { type: string, format: date-time }

    ReturnPointsResponse:
      type: object
      required: [items, total]
      properties:
        items:
          type: array
          items: { $ref: "#/components/schemas/ReturnPoint" }
        total: { type: integer, example: 128 }

paths:
  /auth/register:
    post:
      tags: [Auth]
      summary: Register a new user
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/AuthRegisterRequest" }
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema: { $ref: "#/components/schemas/AuthTokenResponse" }
        "400":
          description: Bad request
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }

  /auth/login:
    post:
      tags: [Auth]
      summary: Login and receive tokens
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/AuthLoginRequest" }
      responses:
        "200":
          description: Ok
          content:
            application/json:
              schema: { $ref: "#/components/schemas/AuthTokenResponse" }
        "401":
          description: Invalid credentials
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }

  /wallet/balance:
    get:
      tags: [Wallet]
      summary: Current wallet balance
      security: [ { bearerAuth: [] } ]
      responses:
        "200":
          description: Ok
          content:
            application/json:
              schema: { $ref: "#/components/schemas/WalletBalanceResponse" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }

  /wallet/history:
    get:
      tags: [Wallet]
      summary: Paginated wallet history
      security: [ { bearerAuth: [] } ]
      parameters:
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: pageSize
          schema: { type: integer, minimum: 1, maximum: 100, default: 20 }
      responses:
        "200":
          description: Ok
          content:
            application/json:
              schema: { $ref: "#/components/schemas/WalletHistoryResponse" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }

  /simulate/return:
    post:
      tags: [Simulator]
      summary: Simulate returning containers (acts like a machine)
      security: [ { bearerAuth: [] } ]
      parameters:
        - $ref: "#/components/parameters/IdempotencyKey"
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/SimulateReturnRequest" }
      responses:
        "200":
          description: Credited
          content:
            application/json:
              schema: { $ref: "#/components/schemas/SimulateReturnResponse" }
        "400":
          description: Validation error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }

  /claims/submit:
    post:
      tags: [Claims]
      summary: Submit a receipt image to claim credit (web-first MVP)
      security: [ { bearerAuth: [] } ]
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [image]
              properties:
                image:
                  type: string
                  format: binary
                note:
                  type: string
                  maxLength: 200
      responses:
        "202":
          description: Accepted for review
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ClaimSubmitResponse" }
        "400":
          description: Bad request
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }

  /return-points:
    get:
      tags: [ReturnPoints]
      summary: List return points (map)
      parameters:
        - in: query
          name: bbox
          description: >
            Optional bounding box "minLng,minLat,maxLng,maxLat".
            If omitted, returns top items by relevance/proximity (server-defined).
          schema: { type: string, example: "-6.4,53.2,-6.1,53.4" }
        - in: query
          name: type
          schema: { type: string, enum: [RVM, Manual] }
        - in: query
          name: openNow
          schema: { type: boolean }
        - in: query
          name: page
          schema: { type: integer, default: 1, minimum: 1 }
        - in: query
          name: pageSize
          schema: { type: integer, default: 100, minimum: 1, maximum: 500 }
      responses:
        "200":
          description: Ok
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ReturnPointsResponse" }

  /healthz:
    get:
      tags: [Health]
      summary: Liveness/readiness probe
      responses:
        "200":
          description: Ok (DB reachable, version ok)
          content:
            application/json:
              schema:
                type: object
                properties:
                  status: { type: string, example: "ok" }
                  db: { type: string, example: "ok" }
                  version: { type: string, example: "0.1.0" }
        "500":
          description: Unhealthy
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
