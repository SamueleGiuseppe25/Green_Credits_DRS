openapi: 3.1.0
info:
  title: GreenCredits API (MVP)
  version: 0.1.0
  description: >
    Minimal contract for parallel frontend/backend work.
    Subscription-based bottle collection platform covering auth, subscriptions, collection slots,
    collections (bookings), vouchers & wallet, return points, and health checks. Payments and voucher
    scanning are simulated for MVP.

servers:
  - url: https://api.greencredits.local
    description: Local/staging (replace in deploy)

tags:
  - name: Auth
  - name: Subscriptions
  - name: CollectionSlots
  - name: Collections
  - name: Wallet
  - name: Admin
  - name: Simulator
  - name: ReturnPoints
  - name: Health

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    IdempotencyKey:
      name: Idempotency-Key
      in: header
      required: false
      description: Client-supplied key to make POST idempotent.
      schema: { type: string, maxLength: 128 }

  schemas:
    Subscription:
      type: object
      required: [status, planCode, startDate]
      properties:
        status:
          type: string
          enum: [active, inactive, canceled]
        planCode:
          type: string
          example: monthly_basic
        startDate:
          type: string
          format: date
        endDate:
          type: string
          format: date

    CollectionSlot:
      type: object
      required: [weekday, startTime, endTime]
      properties:
        weekday:
          type: integer
          minimum: 0
          maximum: 6
          example: 2
        startTime:
          type: string
          example: "18:00:00"
        endTime:
          type: string
          example: "20:00:00"
        preferredReturnPointId:
          type: integer
          nullable: true

    Collection:
      type: object
      required: [id, userId, scheduledAt, returnPointId, status]
      properties:
        id: { type: integer }
        userId: { type: integer }
        scheduledAt: { type: string, format: date-time }
        returnPointId: { type: integer }
        status:
          type: string
          enum: [scheduled, collected, processed, canceled]
        bagCount: { type: integer, minimum: 1, default: 1 }
        notes: { type: string, nullable: true }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }

    Voucher:
      type: object
      required: [id, collectionId, amountCents]
      properties:
        id: { type: string }
        collectionId: { type: string }
        storeChain: { type: string, example: Tesco }
        storeName: { type: string, example: "Tesco Rathmines" }
        amountCents: { type: integer, example: 150 }
        voucherCode: { type: string }
        proofUrl: { type: string }
        donated: { type: boolean, default: false }
        processedAt: { type: string, format: date-time }
        createdAt: { type: string, format: date-time }
    Error:
      type: object
      required: [code, message]
      properties:
        code: { type: string, example: VALIDATION_ERROR }
        message: { type: string, example: "Amount must be >= 0" }
        details:
          description: Optional field-level details or context.
          oneOf:
            - type: string
            - type: object
            - type: array

    AuthRegisterRequest:
      type: object
      required: [email, password]
      properties:
        email: { type: string, format: email, example: "sam@example.com" }
        password: { type: string, format: password, minLength: 8 }
        fullName: { type: string, example: "Sam Quarato" }

    AuthLoginRequest:
      type: object
      required: [email, password]
      properties:
        email: { type: string, format: email }
        password: { type: string, format: password }

    AuthTokenResponse:
      type: object
      required: [accessToken, refreshToken, tokenType, expiresIn]
      properties:
        accessToken: { type: string, example: "eyJhbGciOi..." }
        refreshToken: { type: string, example: "eyJhbGciOi..." }
        tokenType: { type: string, example: "Bearer" }
        expiresIn: { type: integer, example: 3600 }

    WalletBalanceResponse:
      type: object
      required: [balanceCents, lastUpdated]
      properties:
        balanceCents: { type: integer, example: 1230, description: "€12.30 = 1230" }
        lastUpdated: { type: string, format: date-time }

    Transaction:
      type: object
      required: [id, ts, kind, amountCents]
      properties:
        id: { type: string, example: "txn_01H..." }
        ts: { type: string, format: date-time }
        kind:
          type: string
          enum: [return, redeem, donation, adjustment]
        amountCents: { type: integer, example: 150 }
        note: { type: string, example: "5 cans @ €0.15" }

    WalletHistoryResponse:
      type: object
      required: [items, total, page, pageSize]
      properties:
        items:
          type: array
          items: { $ref: "#/components/schemas/Transaction" }
        total: { type: integer, example: 42 }
        page: { type: integer, example: 1 }
        pageSize: { type: integer, example: 20 }

    SimulateReturnRequest:
      type: object
      required: [containers]
      properties:
        containers:
          type: array
          description: List of returned container groups.
          items:
            type: object
            required: [type, count]
            properties:
              type:
                type: string
                enum: [can, small_bottle, large_bottle]
              count:
                type: integer
                minimum: 1
                example: 5

    SimulateReturnResponse:
      type: object
      required: [receiptId, creditedCents, newBalanceCents]
      properties:
        receiptId: { type: string, example: "rcp_01H..." }
        creditedCents: { type: integer, example: 75 }
        newBalanceCents: { type: integer, example: 1305 }


    ReturnPoint:
      type: object
      required: [id, name, type, lat, lng]
      properties:
        id: { type: integer, example: 1 }
        name: { type: string, example: "SuperMart Dundrum RVM" }
        type: { type: string, enum: [RVM, Manual] }
        eircode: { type: string, example: "D14 XXXX" }
        retailer: { type: string, example: "SuperMart" }
        lat: { type: number, format: float, example: 53.2891 }
        lng: { type: number, format: float, example: -6.2387 }

    ReturnPointsResponse:
      type: object
      required: [items, total]
      properties:
        items:
          type: array
          items: { $ref: "#/components/schemas/ReturnPoint" }
        total: { type: integer, example: 128 }

paths:
  /auth/register:
    post:
      tags: [Auth]
      summary: Register a new user
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/AuthRegisterRequest" }
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                type: object
                required: [accessToken, tokenType, expiresIn, user]
                properties:
                  accessToken: { type: string }
                  tokenType: { type: string, example: Bearer }
                  expiresIn: { type: integer, example: 3600 }
                  user:
                    type: object
                    required: [id, email, role]
                    properties:
                      id: { type: integer }
                      email: { type: string }
                      role: { type: string, enum: [user, admin] }
        "400":
          description: Bad request
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }

  /auth/login:
    post:
      tags: [Auth]
      summary: Login and receive tokens
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/AuthLoginRequest" }
      responses:
        "200":
          description: Ok
          content:
            application/json:
              schema:
                type: object
                required: [accessToken, tokenType, expiresIn, user]
                properties:
                  accessToken: { type: string }
                  tokenType: { type: string, example: Bearer }
                  expiresIn: { type: integer, example: 3600 }
                  user:
                    type: object
                    required: [id, email, role]
                    properties:
                      id: { type: integer }
                      email: { type: string }
                      role: { type: string, enum: [user, admin] }

  /subscriptions/me:
    get:
      tags: [Subscriptions]
      summary: Current subscription status for authenticated user
      security: [ { bearerAuth: [] } ]
      responses:
        "200":
          description: Ok
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Subscription" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }

  /subscriptions/activate:
    post:
      tags: [Subscriptions]
      summary: Activate monthly subscription (MVP: simulated payment)
      security: [ { bearerAuth: [] } ]
      responses:
        "200":
          description: Activated
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Subscription" }
        "401": { description: Unauthorized }

  /subscriptions/cancel:
    post:
      tags: [Subscriptions]
      summary: Cancel active subscription
      security: [ { bearerAuth: [] } ]
      responses:
        "200":
          description: Canceled
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Subscription" }
        "401": { description: Unauthorized }

  /collection-slots/me:
    get:
      tags: [CollectionSlots]
      summary: Get current user's weekly slot preference
      security: [ { bearerAuth: [] } ]
      responses:
        "200":
          description: Ok
          content:
            application/json:
              schema: { $ref: "#/components/schemas/CollectionSlot" }
        "401": { description: Unauthorized }
    put:
      tags: [CollectionSlots]
      summary: Upsert weekly slot preference
      security: [ { bearerAuth: [] } ]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/CollectionSlot" }
      responses:
        "200": { description: Ok }
        "201": { description: Created }
        "401": { description: Unauthorized }

  /collections:
    post:
      tags: [Collections]
      summary: Create a new collection booking
      security: [ { bearerAuth: [] } ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [scheduledAt, returnPointId]
              properties:
                scheduledAt: { type: string, format: date-time }
                returnPointId: { type: string }
                bagCount: { type: integer, minimum: 1 }
                notes: { type: string }
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Collection" }
        "400": { description: Validation error }
        "401": { description: Unauthorized }

  /collections/me:
    get:
      tags: [Collections]
      summary: List my collections
      security: [ { bearerAuth: [] } ]
      parameters:
        - in: query
          name: status
          schema: { type: string, enum: [scheduled, collected, processed, canceled] }
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: pageSize
          schema: { type: integer, minimum: 1, maximum: 100, default: 20 }
      responses:
        "200": { description: Ok }
        "401": { description: Unauthorized }

  /collections/{id}/cancel:
    patch:
      tags: [Collections]
      summary: Cancel a scheduled collection
      security: [ { bearerAuth: [] } ]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        "200": { description: Canceled }
        "400": { description: Invalid state }
        "401": { description: Unauthorized }
        "404": { description: Not found }

  /admin/ping:
    get:
      tags: [Admin]
      summary: Admin liveness
      security: [ { bearerAuth: [] } ]
      responses:
        "200": { description: Ok }
        "403": { description: Forbidden }

  /admin/collections/{id}/status:
    patch:
      tags: [Admin]
      summary: Update collection status (admin)
      security: [ { bearerAuth: [] } ]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [status]
              properties:
                status:
                  type: string
                  enum: [scheduled, collected, processed, canceled]
      responses:
        "200": { description: Updated }
        "400": { description: Invalid state }
        "401": { description: Unauthorized }
        "403": { description: Forbidden }
        "404": { description: Not found }

  /wallet/balance:
    get:
      tags: [Wallet]
      summary: Current wallet balance
      security: [ { bearerAuth: [] } ]
      responses:
        "200":
          description: Ok
          content:
            application/json:
              schema: { $ref: "#/components/schemas/WalletBalanceResponse" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }

  /wallet/history:
    get:
      tags: [Wallet]
      summary: Paginated wallet history
      security: [ { bearerAuth: [] } ]
      parameters:
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: pageSize
          schema: { type: integer, minimum: 1, maximum: 100, default: 20 }
      responses:
        "200":
          description: Ok
          content:
            application/json:
              schema: { $ref: "#/components/schemas/WalletHistoryResponse" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }

  /simulate/return:
    post:
      tags: [Simulator]
      summary: Simulate returning containers (acts like a machine)
      security: [ { bearerAuth: [] } ]
      parameters:
        - $ref: "#/components/parameters/IdempotencyKey"
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/SimulateReturnRequest" }
      responses:
        "200":
          description: Credited
          content:
            application/json:
              schema: { $ref: "#/components/schemas/SimulateReturnResponse" }
        "400":
          description: Validation error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }

  /vouchers:
    post:
      tags: [Vouchers]
      summary: Admin records voucher for a processed collection
      security: [ { bearerAuth: [] } ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [collectionId, amountCents, storeChain]
              properties:
                collectionId: { type: string }
                amountCents: { type: integer }
                storeChain: { type: string }
                voucherCode: { type: string }
                proofUrl: { type: string }
                donated: { type: boolean, default: false }
      responses:
        "201": { description: Created }
        "400": { description: Validation error }
        "401": { description: Unauthorized }

  /return-points:
    get:
      tags: [ReturnPoints]
      summary: List return points (map)
      parameters:
        - in: query
          name: chain
          schema: { type: string }
        - in: query
          name: q
          schema: { type: string }
        - in: query
          name: near
          description: lat,lng; sorts by distance if provided
          schema: { type: string, example: "53.2889,-6.2410" }
        - in: query
          name: page
          schema: { type: integer, default: 1, minimum: 1 }
        - in: query
          name: pageSize
          schema: { type: integer, default: 100, minimum: 1, maximum: 500 }
      responses:
        "200":
          description: Ok
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ReturnPointsResponse" }

  /healthz:
    get:
      tags: [Health]
      summary: Liveness/readiness probe
      responses:
        "200":
          description: Ok (DB reachable, version ok)
          content:
            application/json:
              schema:
                type: object
                properties:
                  status: { type: string, example: "ok" }
                  db: { type: string, example: "ok" }
                  version: { type: string, example: "0.1.0" }
        "500":
          description: Unhealthy
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
